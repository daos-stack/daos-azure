#
# Environment Variables for deploying DAOS on Azure
#
# Variable values in <> brackets must be set by the user.
# These values are specific to each user and therefore cannot be defaulted.
#
# Many of the variable values are configured with default values that are set
# by running commands. The defaults may not be valid for your environment.
#
# Using commands to set the default variable values may be convenient, but
# results in slow execution of scripts. You can speed up script execution by
# replacing the commands with their actual output values.
#

# ------------------------------------------------------------------------------
# Values that must be provided by the user
# These values
# ------------------------------------------------------------------------------

# Name of your subscription
DAOS_AZ_CORE_ACCT_NAME="<subscription_name>"

# Name of Resource Group where DAOS server and client resources will be deployed
DAOS_AZ_CORE_RG_NAME="<resource_group_name>"

# Name of Location where DAOS server and client resources will be deployed
DAOS_AZ_CORE_LOCATION="<location>"

# A string that will be prepended to all resource names when creating new
# resources. It is assumed that all other resources in your environment begin
# with this prefix. That assumption may be incorrect so you may need to go
# through all variables in this file and set them with values that match your
# environment.
# If no resource prefix is desired, set to "".
DAOS_AZ_CORE_RESOURCE_PREFIX=""

# Your private and public SSH key files
DAOS_AZ_SSH_ADMIN_KEY="<path_to_your_private_ssh_key>"
DAOS_AZ_SSH_ADMIN_KEY_PUB="<path_to_your_public_ssh_key>"

# IP of the system where you are running the deployment scripts from.
# A rule will be added to a Network Security Group to allow you to access VMs.
# The default value here uses curl to look up your IP.
# If this does not work for you, set the variable value with your IP address.
# If you are a behind a corporate proxy, set the value to your corporate
# proxy IP.
DAOS_AZ_NET_MY_IP="$(curl -s https://api.myip.com | jq -r '.ip')"

# Additional list of IPs which will be allowed to access VMs
# If your team is behind a corporate proxy with multiple proxy IPs, you
# can list the IPs and/or CIDRs for the proxy subnets in a list.
# If you are running packer from your own workstation behind a corporate
# proxy, it may be necessary to provide one or more CIDRs for the proxy IPs.
# Example value:  "[\"192.102.204.32/27\",\"192.55.46.32/27\"]"
DAOS_AZ_NET_ALLOWED_INBOUND_IPS=""

# Name and ID of an Application Service Principal. This Service Principal
# will be used by Packer for building a DAOS image.
# To create an Application Service Principal go to Home>App registrations
DAOS_AZ_PKR_SVC_PRIN_NAME="<app_name>" # App registration name
DAOS_AZ_PKR_SVC_PRIN_CLIENT_ID="<app_client_id>"

# To create an Application Service Principal Secret go to
# Home>App registrations>daos-packer>Certificates & Secrets in the Portal
DAOS_AZ_PKR_SVC_PRIN_SECRET="<service_principal_secret>"

# ------------------------------------------------------------------------------
# Variables with defaults
# ------------------------------------------------------------------------------

# To get more detailed output from the scripts change INFO to DEBUG or
# run
#    export DAOS_AZ_LOG_LEVEL=DEBUG
# in your shell before running any shell scripts in the daos-azure repository.
#
# Do not change the DAOS_AZ_LOG_LEVEL value in this file to
#   DAOS_AZ_LOG_LEVEL=DEBUG
#
# That will result in always overriding the value.
#
# If you want to default to DEBUG logging set
#   DAOS_AZ_LOG_LEVEL="${DAOS_AZ_LOG_LEVEL:="DEBUG"}"
#
# so that if the DAOS_AZ_LOG_LEVEL variable is exported in the environment
# before running shell scripts the exported value is used.
DAOS_AZ_LOG_LEVEL="${DAOS_AZ_LOG_LEVEL:="INFO"}"

DAOS_AZ_CORE_ACCT_ID="$(az account list --output json | jq -r --arg name "$DAOS_AZ_CORE_ACCT_NAME" '.[] | select(.name == $name) | .id')"
DAOS_AZ_CORE_TENANT_ID="$(az account list --output json | jq -r --arg name "$DAOS_AZ_CORE_ACCT_NAME" '.[] | select(.name == $name) | .tenantId')"

# Key vault name where DAOS certificates will be stored
# The default assumes that you have created a Key Vault in the same resource
# group where DAOS servers and clients will be deployed and that the name of
# Key Vault contains the word 'daos' in lower case.
DAOS_AZ_CORE_KEY_VAULT_NAME="$(az keyvault list --resource-group "${DAOS_AZ_CORE_RG_NAME}" --resource-type vault --query "[?contains(name,'daos')].name" -o tsv)"

# Existing VNet where DAOS servers and clients will be deployed.
# The default assumes that you have created a VNet in the same resource
# group where DAOS servers and clients will be deployed and that the name of
# VNet contains the word 'daos' in lower case.
DAOS_AZ_NET_VNET_NAME="$(az network vnet list --resource-group "${DAOS_AZ_CORE_RG_NAME}" --query "[?contains(name,'daos')].name" -o tsv)"

# Existing Subnet where DAOS servers and clients will be deployed.
# The default assumes that you have created a Subnet within the
# DAOS_AZ_NET_VNET_NAME in the same resource group where DAOS servers and
# clients will be deployed and that the name of subnet contains the word 'daos'
# in lower case.
DAOS_AZ_NET_SUBNET_NAME="$(az network vnet subnet list --resource-group "${DAOS_AZ_CORE_RG_NAME}" --vnet-name "${DAOS_AZ_NET_VNET_NAME}" --query "[?contains(name,'daos')].name" -o tsv)"

# Packer Variables
DAOS_AZ_PKR_TEMPLATE_FILE="daos_from_source.pkr.hcl"
DAOS_AZ_PKR_VM_SIZE="Standard_L8s_v3"
DAOS_AZ_PKR_USE_CLI_AUTH="false"
DAOS_AZ_PKR_SRC_IMG_OFFER="almalinux"
DAOS_AZ_PKR_SRC_IMG_PUBLISHER="almalinux"
DAOS_AZ_PKR_SRC_IMG_SKU="8-gen2"
DAOS_AZ_PKR_SRC_IMG_VERSION="8.7.2022122801"
DAOS_AZ_PKR_DEST_IMG_GAL_RG_NAME="${DAOS_AZ_CORE_RESOURCE_PREFIX:+${DAOS_AZ_CORE_RESOURCE_PREFIX}-}common-rg"
DAOS_AZ_PKR_DEST_IMG_GAL_LOCATION="${DAOS_AZ_CORE_LOCATION}"
DAOS_AZ_PKR_DEST_IMG_GAL_NAME="${DAOS_AZ_CORE_RESOURCE_PREFIX:+${DAOS_AZ_CORE_RESOURCE_PREFIX}_}common_ig"
DAOS_AZ_PKR_DEST_IMG_OFFER="daos"
DAOS_AZ_PKR_DEST_IMG_PUBLISHER="daos"
DAOS_AZ_PKR_DEST_IMG_NAME="daos-almalinux8"
DAOS_AZ_PKR_DEST_IMG_VERSION_PREFIX="2.4"
DAOS_AZ_PKR_DAOS_GIT_REPO_URL="https://github.com/daos-stack/daos.git"
DAOS_AZ_PKR_DAOS_GIT_REPO_BRANCH="release/2.4"
DAOS_AZ_PKR_DAOS_GIT_REPO_TAG=""

# ARM deployment variables
DAOS_AZ_ARM_UAMID_NAME="$(az identity list --resource-group "${DAOS_AZ_CORE_RG_NAME}" --query "[?contains(name, 'daos')].name" -o tsv)"
DAOS_AZ_ARM_UAMID="/subscriptions/${DAOS_AZ_CORE_ACCT_ID}/resourcegroups/${DAOS_AZ_CORE_RG_NAME}/providers/Microsoft.ManagedIdentity/userAssignedIdentities/${DAOS_AZ_ARM_UAMID_NAME}"
DAOS_AZ_ARM_KEY_VAULT_NAME="$(az keyvault list --resource-group "${DAOS_AZ_CORE_RG_NAME}" --resource-type vault --query "[?contains(name, 'daos')].name" -o tsv)"
DAOS_AZ_ARM_ADMIN_IMG_ID="/subscriptions/${DAOS_AZ_CORE_ACCT_ID}/resourceGroups/${DAOS_AZ_PKR_DEST_IMG_GAL_RG_NAME}/providers/Microsoft.Compute/images/${DAOS_AZ_PKR_DEST_IMG_NAME}"
DAOS_AZ_ARM_SVR_IMG_ID="/subscriptions/${DAOS_AZ_CORE_ACCT_ID}/resourceGroups/${DAOS_AZ_PKR_DEST_IMG_GAL_RG_NAME}/providers/Microsoft.Compute/images/${DAOS_AZ_PKR_DEST_IMG_NAME}"
DAOS_AZ_ARM_SVR_GROUP_DEPLOYMENT_NAME="${DAOS_AZ_CORE_RESOURCE_PREFIX:+${DAOS_AZ_CORE_RESOURCE_PREFIX}-}daos-server-deployment"
DAOS_AZ_ARM_SVR_SRC_TEMPLATE="azuredeploy_server_template.json"
DAOS_AZ_ARM_SVR_DEST_TEMPLATE="azuredeploy_server.json"
DAOS_AZ_ARM_SVR_VMSS_NAME="${DAOS_AZ_CORE_RESOURCE_PREFIX:+${DAOS_AZ_CORE_RESOURCE_PREFIX}-}daos-server-vmss"
DAOS_AZ_ARM_ADMIN_SKU="Standard_L8s_v3"
DAOS_AZ_ARM_SVR_SKU="Standard_L8s_v3"
DAOS_AZ_ARM_ADMIN_USER="daos_admin"
DAOS_AZ_ARM_SVR_COUNT=3
DAOS_AZ_ARM_SVR_DISK_COUNT=8
DAOS_AZ_ARM_SVR_DISK_SIZE=1024
DAOS_AZ_ARM_SVR_DISK_STORAGE_SKU="Premium_LRS"
DAOS_AZ_ARM_SVR_DISK_CACHE_OPTION="None"
DAOS_AZ_ARM_SVR_USE_AVAIL_ZONE="true"
DAOS_AZ_ARM_SVR_AVAIL_ZONE=1

# DAOS configuration variables
DAOS_AZ_CFG_ALLOW_INSECURE="false"
DAOS_AZ_CFG_NR_HUGEPAGES="8096"
DAOS_AZ_CFG_SCM_SIZE_GB=16
DAOS_AZ_CFG_TARGETS="${DAOS_AZ_ARM_SVR_DISK_COUNT}"
DAOS_AZ_CFG_NR_XS_HELPERS=0
DAOS_AZ_CFG_CONTROL_LOG_MASK=INFO

# DAOS Pool variables
DAOS_AZ_POOL_NAME="pool1"
DAOS_AZ_POOL_SIZE="100%"
